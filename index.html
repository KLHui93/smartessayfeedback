<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Essay Feedback for UASA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: "Inter", sans-serif;
            background-color: #eef2f6; /* Lighter, modern background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent content overflow */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 24px; /* More rounded corners */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            padding: 40px; /* More padding */
            max-width: 1000px; /* Slightly wider */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Increased gap between sections */
        }
        video, canvas, img {
            border-radius: 16px; /* More rounded corners */
            background-color: #f8fafc; /* Lighter placeholder background */
            object-fit: contain;
            max-width: 100%;
            height: auto;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        .btn {
            padding: 14px 28px; /* Larger buttons */
            border-radius: 12px; /* More rounded buttons */
            font-weight: 700; /* Bolder text */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smoother transitions */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* More space for icons */
            font-size: 1.05rem; /* Slightly larger text */
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* Gradient background */
            color: white;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); /* Gradient shadow */
            border: none;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 12px 25px rgba(99, 102, 241, 0.5);
        }
        .btn-secondary {
            background-color: #e0e7ff;
            color: #4f46e5;
            border: 1px solid #a5b4fc; /* Stronger border */
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.1);
        }
        .btn-secondary:hover {
            background-color: #c7d2fe;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.2);
        }
        .loading-spinner {
            border: 5px solid rgba(0, 0, 0, 0.1); /* Thicker spinner */
            border-left-color: #6366f1; /* Primary color for spinner */
            border-radius: 50%;
            width: 30px; /* Larger spinner */
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .grid-cols-md-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .feedback-section {
            background-color: #f8fafc; /* Light background for feedback */
            border-radius: 16px;
            padding: 30px;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05); /* Inner shadow for depth */
            text-align: left; /* Align feedback text to left */
        }
        .feedback-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 10px;
        }
        .feedback-section p {
            line-height: 1.7;
            color: #475569;
        }
        .score-display {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .score-item {
            background-color: #eff6ff; /* Light blue background */
            color: #1e40af; /* Dark blue text */
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 150px; /* Ensure minimum width */
            text-align: center;
        }
        .score-item span:first-child {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .overall-score {
            font-size: 1.8rem;
            font-weight: 800;
            color: #10b981; /* Green for overall score */
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">Smart Essay Feedback for UASA <span class="text-indigo-600"></span></h1>

        <!-- Part Selection -->
        <div class="flex flex-col items-center gap-6 mb-8 p-6 bg-blue-50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-700">Select Essay Part:</h2>
            <div class="flex flex-col sm:flex-row gap-8">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" class="form-radio text-indigo-600 h-6 w-6" name="essayPart" value="Part 6" checked>
                    <span class="ml-3 text-gray-800 font-semibold text-lg">Part 6 (10 Marks)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" class="form-radio text-indigo-600 h-6 w-6" name="essayPart" value="Part 7">
                    <span class="ml-3 text-gray-800 font-semibold text-lg">Part 7 (15 Marks)</span>
                </label>
            </div>
        </div>

        <!-- Camera Feed and Controls -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="flex flex-col items-center gap-6 bg-gray-50 p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-700">1. Capture Essay Photo</h2>
                <video id="video" class="w-full h-80 bg-gray-200" autoplay playsinline></video>
                <button id="captureButton" class="btn btn-primary w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15.5a2.25 2.25 0 0 0 2.25-2.25V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055m-18.177 6.643C2.86 14.156 3.61 15 4.662 15h14.676c1.052 0 1.802-.844 1.802-1.926 0-.38-.043-.756-.128-1.127M16.5 12a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z" />
                    </svg>
                    Capture Photo
                </button>
            </div>

            <div class="flex flex-col items-center gap-6 bg-gray-50 p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-700">2. Captured Image</h2>
                <canvas id="canvas" class="hidden w-full h-80 bg-gray-200"></canvas>
                <img id="photo" class="hidden w-full h-80 bg-gray-200" alt="Captured Photo">
                <button id="analyzeButton" class="btn btn-secondary w-full hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9.75 9.75m0 0l-1.35 1.35M9.75 9.75L7.5 7.5M18 18.084V17.25a2.25 2.25 0 00-2.25-2.25H13.5a2.25 2.25 0 00-2.25 2.25v.834m7.5 0H21a2.25 2.25 0 002.25-2.25V10.5a2.25 2.25 0 00-2.25-2.25H15.75m-1.5 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V15.75m-1.5-1.5V9.75m-3 0V3.375C11.25 2.596 10.596 2 9.75 2H4.5A2.25 2.25 0 002.25 4.25v16.5A2.25 2.25 0 004.5 23h15a2.25 2.25 0 002.25-2.25v-6.75" />
                    </svg>
                    Analyze Essay
                </button>
            </div>
        </div>

        <!-- AI Feedback Section -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">3. AI Feedback</h2>
            <div id="feedbackContainer" class="feedback-section min-h-[200px] flex flex-col items-center justify-center text-gray-600 text-center">
                <p id="feedbackText" class="text-lg">Capture a photo and click "Analyze Essay" to get feedback.</p>
                <div id="loadingSpinner" class="hidden loading-spinner mt-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Get references to DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const captureButton = document.getElementById('captureButton');
        const analyzeButton = document.getElementById('analyzeButton');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const feedbackText = document.getElementById('feedbackText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const context = canvas.getContext('2d');
        const essayPartRadios = document.querySelectorAll('input[name="essayPart"]');

        let stream; // To hold the camera stream
        let capturedImageData = null; // To store base64 image data

        // Function to start camera stream
        async function startCamera() {
            try {
                // Request access to the user's camera
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); // Prefer rear camera
                video.srcObject = stream; // Set the video source to the camera stream
                video.play(); // Start playing the video
                captureButton.disabled = false; // Enable capture button once camera is ready
            } catch (err) {
                // Display error if camera access is denied or fails
                feedbackText.textContent = 'Error: Could not access the camera. Please ensure you have granted camera permissions.';
                console.error('Error accessing camera:', err);
                captureButton.disabled = true;
            }
        }

        // Function to capture photo
        captureButton.addEventListener('click', () => {
            if (!stream) {
                feedbackText.textContent = 'Camera not active. Please refresh and allow camera access.';
                return;
            }

            // Set canvas dimensions to match video stream
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw the current video frame onto the canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Get the image data as a base64 string
            capturedImageData = canvas.toDataURL('image/png');

            // Display the captured photo and show the analyze button
            photo.src = capturedImageData;
            photo.classList.remove('hidden');
            canvas.classList.add('hidden'); // Hide canvas, show img
            analyzeButton.classList.remove('hidden');
            feedbackText.innerHTML = '<p class="text-lg">Photo captured. Click "Analyze Essay" to get feedback.</p>';
        });

        // Function to send image to AI for analysis
        analyzeButton.addEventListener('click', async () => {
            if (!capturedImageData) {
                feedbackText.innerHTML = '<p class="text-lg">No photo captured yet. Please capture a photo first.</p>';
                return;
            }

            // Get the selected essay part
            let selectedPart = 'Part 6'; // Default to Part 6
            for (const radio of essayPartRadios) {
                if (radio.checked) {
                    selectedPart = radio.value;
                    break;
                }
            }

            // Show loading spinner and clear previous feedback
            feedbackText.innerHTML = `<p class="text-lg text-indigo-600">Analyzing essay for ${selectedPart}...</p>`;
            loadingSpinner.classList.remove('hidden');
            analyzeButton.disabled = true; // Disable button during analysis

            try {
                // Extract base64 data part (remove "data:image/png;base64,")
                const base64Data = capturedImageData.split(',')[1];

                // Prepare the payload for the Gemini API
                let chatHistory = [];
                const prompt = `You are an AI assistant specialized in evaluating UASA English essays for Year 4 to Year 6.
                The user has indicated this essay should be evaluated as **${selectedPart}**.

Here are the rubrics:

**Part 6 (10M) Rubric:**
* Score 5: All content is relevant to the task. Target reader is fully informed. Produces a text that communicates straightforward ideas using the conventions of the communicative task reasonably well. Uses simple connectors and a limited number of cohesive devices appropriately. Uses basic vocabulary appropriately. Uses simple grammatical forms with a good degree of control. While errors are noticeable, meaning can still be determined.
* Score 4: Performance shares features of scores 3 and 5.
* Score 3: Target reader is on the whole informed. Minor irrelevances and/or omissions may be present. Produces a text that communicates simple ideas in simple ways. Text is connected using basic, high frequency connectors. Uses basic vocabulary reasonably. Uses simple grammatical forms with some degree of control. Errors may impede meaning at times.
* Score 2: Performance shares features of scores 1 and 3.
* Score 1: Target reader is minimally informed. Irrelevances and/or misinterpretation of task may be present. Produces isolated short units about simple and concrete matters, not always communicating successfully. Production unlikely to be connected, though punctuation and simple connectors (i.e., and) may be used on occasion. Produces basic vocabulary of isolated words and phrases. Produces few simple grammatical forms with only limited control.
* Score 0: Performance below score 1.

**Part 7 (15M) Rubric:**
* Score 5: All content is relevant to the task. Target reader is fully informed. Produces a text that communicates straightforward ideas using the conventions of the communicative task reasonably well. Uses simple connectors and a limited number of cohesive devices appropriately. Uses basic vocabulary appropriately. Uses simple grammatical forms with a good degree of control. While errors are noticeable, meaning can still be determined.
* Score 4: Performance shares features of scores 3 and 5.
* Score 3: Target reader is on the whole informed. Minor irrelevances and/or omissions may be present. Produces a text that communicates simple ideas in simple ways. Text is connected using basic, high frequency connectors. Uses basic vocabulary reasonably. Uses simple grammatical forms with some degree of control. Errors may impede meaning at times.
* Score 2: Performance shares features of scores 1 and 3.
* Score 1: Target reader is minimally informed. Irrelevances and/or misinterpretation of task may be present. Produces isolated short units about simple and concrete matters, not always communicating successfully. Production unlikely to be connected, though punctuation and simple connectors (i.e., and) may be used on occasion. Produces basic vocabulary of isolated words and phrases. Produces few simple grammatical forms with only limited control.
* Score 0: Performance below band 1.

**Instructions:**
1.  **Extract the essay text** from the provided image.
2.  **Evaluate the essay specifically against the rubric for ${selectedPart}**.
3.  **Provide a score (1-5) for each relevant category**.
4.  **Provide an overall score.**
5.  **Give detailed, constructive feedback** for each category, explaining *why* the score was given based on the rubric criteria.
6.  **Suggest specific improvements** for the student to achieve a higher score. Keep these suggestions short, concise sentences.
7.  If no essay text is detected, please state that clearly.
8.  Do not use excessive bolding or markdown in your response, only use it for section titles as specified below.

**Format the output as follows:**
Content & Communicative Achievement: [Score]/5
Organisation & Language: [Score]/5
Overall Mark: [Calculated Overall Score]/[Max Score for Part]

Improvement:
[Short sentence 1].
[Short sentence 2].
[Short sentence 3].
...

For Part 7, the format should be:
Content: [Score]/5
Communicative Achievement: [Score]/5
Organisation & Language: [Score]/5
Overall Mark: [Calculated Overall Score]/[Max Score for Part]

Improvement:
[Short sentence 1].
[Short sentence 2].
[Short sentence 3].
...
`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "image/png",
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                };

                // API key will be provided by the Canvas environment
                const apiKey = "AIzaSyB5HvC6atp12cA1redrNznyzfnRLA7VFXQ";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                // Make the API call
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                // Process the AI response
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiFeedback = result.candidates[0].content.parts[0].text;
                    // Replace newlines with <br> for HTML display
                    feedbackText.innerHTML = aiFeedback.replace(/\n/g, '<br>');
                    // Also, ensure the text alignment is left for better readability of the feedback
                    feedbackContainer.style.textAlign = 'left';
                } else {
                    feedbackText.innerHTML = '<p class="text-lg text-red-600">Could not get AI feedback. Please try again.</p>';
                    console.error('Unexpected API response structure:', result);
                }

            } catch (error) {
                // Handle any errors during the API call
                feedbackText.innerHTML = `<p class="text-lg text-red-600">Error analyzing essay: ${error.message}. Please try again.</p>`;
                console.error('Error during AI analysis:', error);
            } finally {
                // Hide loading spinner and re-enable button
                loadingSpinner.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        });

        // Start camera when the window loads
        window.onload = startCamera;
    </script>
</body>
</html>
